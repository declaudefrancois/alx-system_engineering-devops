#!/usr/bin/env bash
# Install and configure HAproxy on `lb-01` server
# so that it distribute traffic to `web-01` and `web-02` servers.

# Install HAproxy.
apt update
apt-get install -y --no-install-recommends software-properties-common
add-apt-repository -y ppa:vbernat/haproxy-2.6
apt-get install -y haproxy=2.6.\*

# Enable the HAProxy init script.
systemctl enable haproxy

# Create the configuration file for HAproxy
cat << EOF >> /etc/haproxy/haproxy.cfg

defaults
	mode http
	option dontlognull
	option redispatch
	option contstats
	balance roundrobin

	# wait for up to 30 seconds in the queue, after which HAProxy returns a 503 Service Unavailable.
	timeout queue 30s

	# within 10 seconds of inactivity (e.g: not sending reponses or response headers) , the client will receive a 504 Gateway timeout error from HAProxy.
	timeout server 10s
	
	# Attempt to connect to the server 4 times before giving up and returning Service Unavailable to the client.
	retries 5

	# 5 second max to connect or to stay in queue.
	timeout connect 5s

	timeout client 30s

	timeout http-keep-alive 5s
	timeout http-request 15s
	backlog 10000

frontend stats
        mode http
        bind *:8404
        stats enable
        stats uri /stats
        stats refresh 10s
        stats admin if LOCALHOST

frontend lb-01-frontend
	bind :80
	default_backend lb-01-backend_servers
	rate-limit sessions 100
	maxconn 1000

backend lb-01-backend_servers
	balance roundrobin
	option httpchk port 80
	http-check send meth GET uri /
	server 119337-web-01 52.86.238.153:80 check port 80 maxconn 1000 maxqueue 100
	server 119337-web-02 54.236.33.249:80 check port 80 maxconn 1000 maxqueue 100
EOF

# Apply configuration.
systemctl restart haproxy
