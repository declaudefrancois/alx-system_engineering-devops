defaults
        mode http
        option dontlognull
        option redispatch
        option contstats
        balance roundrobin

        # preserve header case.
        no option http-use-htx

        # wait for up to 30 seconds in the queue, after which HAProxy returns a 503 Service Unavailable.
        timeout queue 30s

        # within 10 seconds of inactivity (e.g: not sending reponses or response headers) , the client will receive a 504 Gateway timeout error from HAProxy.
        timeout server 10s

        # Attempt to connect to the server 4 times before giving up and returning Service Unavailable to the client.
        retries 5

        # 5 second max to connect or to stay in queue.
        timeout connect 5s

        timeout client 30s

        timeout http-keep-alive 5s
        timeout http-request 15s
        backlog 10000

frontend lb-01
        bind :80
	bind :443 ssl crt /etc/haproxy/cert/www.nguvu.tech.pem

        # create an acl "is_acme_chlge" to check if the request is an http-01 acme challenge.
        acl is_acme_chlge path_beg /.well-known/acme-challenge/

        # if the is_acme_chlge return true, the standalone letsencrypt server will handle the request.
        use_backend letsencrypt if is_acme_chlge

        # redirect http to https
        http-request redirect scheme https code 301 unless { ssl_fc }

        # default backend for all other requests.
        default_backend nguvu-app

backend letsencrypt
        # standalone letsencrypt server listening on 4444
        server letsencrypt 127.0.0.1:4444

backend nguvu-app
        balance roundrobin
        server web-01 100.25.13.40:80 check port 80 maxconn 1000 maxqueue 100
        server web-02 54.162.241.237:80 check port 80 maxconn 1000 maxqueue 100

